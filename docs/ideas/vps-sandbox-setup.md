# Claude Code Sandbox Setup — RackNerd VPS

Guide for running Claude Code autonomously on a remote VPS, focused on the skills repo (`OM-Agency`). Expand to general dev later.

**Server:** RackNerd 4GB RAM VPS
**Goal:** Claude Code works autonomously on a branch → you review on GitHub

---

## 1. Server Prep

SSH into your VPS and install dependencies:

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install essentials
sudo apt install -y git curl build-essential ripgrep

# Install sandboxing support
sudo apt install -y bubblewrap socat

# Install Node.js 20+ (required for Claude Code)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash -
sudo apt install -y nodejs

# Verify
node --version  # Should be 20+
npm --version
git --version
```

## 2. Install Claude Code

```bash
# Install Claude Code CLI
npm install -g @anthropic-ai/claude-code

# Verify
claude --version
```

## 3. Authenticate

You need to auth once interactively:

```bash
claude
# Follow the OAuth flow in your browser
# Once authenticated, exit with /exit
```

Your API key / OAuth token will be stored locally.

## 4. Set Up the Repo

```bash
# Create workspace
mkdir -p ~/workspace && cd ~/workspace

# Clone the skills repo
git clone https://github.com/opsMachine/OM-Agency.git
cd OM-Agency

# Configure git identity
git config user.name "Claude Code (Sandbox)"
git config user.email "claude-sandbox@opsmachine.dev"

# Verify
git status
```

## 5. Create Sandbox Settings

Create `~/.claude/settings.json` on the VPS:

```json
{
  "permissions": {
    "allow": [
      "Bash(git status:*)",
      "Bash(git log:*)",
      "Bash(git diff:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git branch:*)",
      "Bash(git checkout:*)",
      "Bash(git push:*)",
      "Bash(git stash:*)",
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(wc:*)",
      "Bash(echo:*)",
      "Bash(mkdir:*)",
      "Bash(cp:*)"
    ]
  }
}
```

This is the safe allowlist — git ops and read-only shell. No npm install, no sudo, no rm.

## 6. Set Environment Variables

Add to `~/.bashrc`:

```bash
# Claude Code sandbox settings
export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
export DISABLE_AUTOUPDATER=1
```

Then: `source ~/.bashrc`

## 7. The Workflow Script

Create `~/run-task.sh`:

```bash
#!/bin/bash
set -euo pipefail

# --- Config ---
REPO_DIR="$HOME/workspace/OM-Agency"
BRANCH_PREFIX="sandbox"
MAX_BUDGET="5.00"
MAX_TURNS="20"

# --- Input ---
TASK="${1:?Usage: ./run-task.sh 'task description'}"
BRANCH_NAME="${2:-$BRANCH_PREFIX/$(date +%Y%m%d-%H%M%S)}"

# --- Setup ---
cd "$REPO_DIR"
git fetch origin
git checkout main
git pull origin main

# Create work branch
git checkout -b "$BRANCH_NAME"

echo "=== Starting Claude Code ==="
echo "Task: $TASK"
echo "Branch: $BRANCH_NAME"
echo "Budget: \$$MAX_BUDGET"
echo ""

# --- Run Claude ---
claude -p "$TASK" \
  --dangerously-skip-permissions \
  --output-format json \
  --max-turns "$MAX_TURNS" \
  | tee "/tmp/claude-output-$(date +%s).json"

# --- Push results ---
echo ""
echo "=== Pushing to GitHub ==="
git push origin "$BRANCH_NAME"

echo ""
echo "=== Done ==="
echo "Review at: https://github.com/opsMachine/OM-Agency/compare/main...$BRANCH_NAME"
```

Make executable: `chmod +x ~/run-task.sh`

### Usage

```bash
# Simple task
~/run-task.sh "Merge implement-direct and implement-to-pass into a single skill"

# With custom branch name
~/run-task.sh "Add test-planning section to playbook" "sandbox/add-test-planning"
```

## 8. Alternative: Controlled Permissions (Not Skip-All)

If you'd rather not use `--dangerously-skip-permissions`, use `--allowedTools` instead:

```bash
claude -p "$TASK" \
  --permission-mode dontAsk \
  --allowedTools "Bash(git *),Read,Edit,Grep,Glob,Write" \
  --output-format json \
  --max-turns "$MAX_TURNS"
```

This denies everything by default and only allows explicitly listed tools. Safer, but may fail on unexpected operations.

## 9. Review Workflow

Once Claude pushes a branch:

1. **Get notification** — Set up GitHub email notifications or check manually
2. **Review the diff** — `https://github.com/opsMachine/OM-Agency/compare/main...sandbox/BRANCH`
3. **If good** — Merge via GitHub PR or locally
4. **If not** — Comment on the PR with feedback, run another task to fix

### Optional: Auto-Create PR

Add to the end of `run-task.sh`:

```bash
# Install gh CLI if not present
# sudo apt install gh && gh auth login

gh pr create \
  --title "Sandbox: $(echo "$TASK" | head -c 60)" \
  --body "$(cat <<EOF
## Task
$TASK

## Branch
\`$BRANCH_NAME\`

---
Generated by Claude Code sandbox
EOF
)"
```

## 10. Security Notes

- The VPS is isolated from your local machine — worst case, Claude messes up the repo, you `git reset`
- `--dangerously-skip-permissions` is fine here because:
  - It's an isolated VM
  - The repo is a clone (origin is the source of truth)
  - No secrets, no production access, no databases
  - All work goes through GitHub review before merging
- Don't store API keys, `.env` files, or credentials on the VPS
- Don't give Claude access to other repos or system files until you expand scope

## 11. Expanding Later

When you're ready to use this for product repos:

1. Clone the product repo alongside OM-Agency
2. Copy/adapt `run-task.sh` with the new repo path
3. Add supabase CLI if needed: `npm install -g supabase`
4. Consider adding Docker for full stack testing
5. Update the allowlist for stack-specific commands (npm test, etc.)

---

## Quick Reference

| Command | What it does |
|---------|-------------|
| `~/run-task.sh "task"` | Run Claude on a task, push to branch |
| `claude -p "task" --dangerously-skip-permissions` | One-off headless run |
| `claude -p "task" --resume SESSION_ID` | Continue a previous session |
| `claude --version` | Check Claude Code version |
